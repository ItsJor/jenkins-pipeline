pipeline {

    agent any

    parameters {
        string(name: 'GIT_REPO_URL', defaultValue: 'https://github.com/ItsJor/sw_r_assist.git', description: 'Repository link for build - java')
        string(name: 'GIT_BUILD_BRANCH', defaultValue: 'main', description: 'Branch for the build')
        choice(name: 'BUILD_ENVIRONMENT', choices: ['dev', 'uat', 'prod'], description: 'Environment to build out')
    }

    environment {
        SPRING_PROFILE_ACTIVE = "$params.BUILD_ENVIRONMENT"
        DB_USERNAME = credentials('DB_USERNAME')
        DB_PASSWORD = credentials('DB_PASSWORD')
        DB_DATASOURCE = credentials('DB_DATASOURCE')
        API_INSTANCE_LOCATION = credentials('API_INSTANCE_LOCATION')
    }

    stages {

        stage('Clone repository') {
            steps {
                echo 'Cloning repository from: ' + params.GIT_REPO_URL
                echo 'Cloning on branch: ' + params.GIT_BUILD_BRANCH
                git(url: params.GIT_REPO_URL, branch: params.GIT_BUILD_BRANCH, credentialsId: 'github_pat')
            }
        }
        stage('Build project') {
            steps {
                sh './mvnw clean install -DskipTests=true'
            }
        }
        stage('Push artifact to api instance') {
            steps {
                sh 'scp -i /target/sampleApi-0.0.1-SNAPSHOT.jar ec2-user@${API_INSTANCE_LOCATION}'
            }
        }
        
    }

    post {
        always {
            echo 'Cleaning workspace'
            cleanWs()
        }
    }

}